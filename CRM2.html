<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ADC · Mini CRM (Elegant UI)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
  :root{
    --brand:#3b82f6; --brand-2:#1d4ed8; --ok:#16a34a; --warn:#d97706; --bad:#ef4444;
    --text:#0f172a; --muted:#64748b;
    --line:#e2e8f0; --line-2:#e5e7eb;
    --surface:#ffffff; --surface-2:#f8fafc; --surface-3:#f1f5f9;
    --bg:linear-gradient(170deg,#f7fbff 0%,#f6f8fc 35%,#f8fafc 100%);
    --shadow:0 12px 28px rgba(2,6,23,.08);
    --shadow-lg:0 18px 36px rgba(2,6,23,.12);
    --radius:16px; --radius-sm:12px; --radius-lg:22px;
    --chip:#eef2ff;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --text:#e5e7eb; --muted:#a3b2c7;
      --surface:#0b1220; --surface-2:#0a0f1a; --surface-3:#0e1726;
      --bg:radial-gradient(1100px 480px at -10% -10%, rgba(59,130,246,.15), transparent 60%), linear-gradient(160deg,#0b1220 0%,#0a1220 40%,#0b1220 100%);
      --line:#1f2937; --line-2:#243043;
      --shadow:0 18px 36px rgba(0,0,0,.42);
      --shadow-lg:0 28px 60px rgba(0,0,0,.5);
      --chip:#13233f;
    }
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
    color:var(--text); background:var(--bg);
  }

  /* Header */
  header{
    position:sticky; top:0; z-index:40;
    backdrop-filter:saturate(1.1) blur(8px);
    background:linear-gradient(120deg, rgba(59,130,246,.12), rgba(59,130,246,.08));
    border-bottom:1px solid var(--line);
  }
  .wrap{max-width:1200px; margin:0 auto; padding:16px}
  h1{margin:0; font-size:20px; font-weight:800; letter-spacing:.2px}
  .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .muted{color:var(--muted); font-size:12px}

  /* Cards / layout */
  .grid{display:grid; gap:16px}
  .two{grid-template-columns:1fr}
  .card{
    background:var(--surface);
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:16px;
  }
  label{font-weight:800; font-size:12px; color:var(--muted)}
  input,select,textarea{
    width:100%; padding:12px 14px; border:1px solid var(--line);
    border-radius:12px; background:var(--surface-2); color:var(--text); font-weight:600
  }
  textarea{min-height:84px}
  .row{display:grid; grid-template-columns:repeat(4,1fr); gap:12px}
  .row-3{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
  .row-2{display:grid; grid-template-columns:repeat(2,1fr); gap:12px}

  /* Buttons */
  .btn{
    display:inline-flex; align-items:center; gap:8px;
    border:1px solid var(--line); border-radius:12px; padding:10px 14px;
    cursor:pointer; background:var(--surface); font-weight:800; color:var(--text);
    transition:transform .15s ease, filter .15s ease;
  }
  .btn:hover{ transform:translateY(-1px); filter:brightness(1.02) }
  .btn.primary{ background:linear-gradient(180deg,var(--brand),var(--brand-2)); color:#fff; border-color:transparent; box-shadow:var(--shadow-lg) }
  .btn.ok{ background:linear-gradient(180deg,var(--ok),#15803d); color:#fff; border-color:transparent }
  .btn.warn{ background:linear-gradient(180deg,var(--warn),#b45309); color:#fff; border-color:transparent }
  .btn.bad{ background:linear-gradient(180deg,var(--bad),#b91c1c); color:#fff; border-color:transparent }
  .right{display:flex; gap:10px; justify-content:flex-end}

  /* Table */
  .table-scroll{width:100%; overflow:auto; border-radius:14px; border:1px solid var(--line); background:var(--surface)}
  table{width:100%; border-collapse:separate; border-spacing:0; min-width:920px}
  thead th{
    position:sticky; top:0; z-index:1; background:var(--surface-3);
    border-bottom:1px solid var(--line-2); color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.4px;
    padding:12px 14px;
  }
  tbody td{
    padding:12px 14px; border-bottom:1px solid var(--line);
    vertical-align:top; font-size:14px;
    background:linear-gradient(180deg, transparent, transparent)
  }
  tbody tr:nth-child(even) td{ background:linear-gradient(180deg, rgba(2,6,23,.02),transparent) }
  tbody tr:hover td{ background:linear-gradient(180deg, rgba(59,130,246,.07), transparent) }

  .chip{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid var(--line); background:var(--chip); color:var(--brand-2); font-weight:800}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid var(--line); background:#eaf2ff; color:#1d4ed8}
  .pill.ok{background:#dcfce7; color:#166534}
  .pill.bad{background:#fee2e2; color:#7f1d1d}
  .pill.warn{background:#fff7ed; color:#92400e}
  .due{color:#fff; background:#ef4444; padding:3px 8px; border-radius:10px; font-weight:800; font-size:11px}

  .hide{display:none}
  #loading{display:none; align-items:center; gap:8px; font-weight:800}

  /* Auth overlay */
  #auth{position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
        background:rgba(0,0,0,.10); backdrop-filter:blur(6px); z-index:9999}
  #auth .panel{width:380px; max-width:95%; background:var(--surface); border:1px solid var(--line);
        border-radius:18px; box-shadow:var(--shadow-lg); padding:18px}

  /* Modal (Business page) */
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:18px; z-index:1000}
  .panel{
    max-width:960px; width:100%; background:var(--surface); border:1px solid var(--line);
    border-radius:18px; box-shadow:var(--shadow-lg); display:flex; flex-direction:column; max-height:92vh;
  }
  .panel .head{
    position:sticky; top:0; background:var(--surface-3); border-bottom:1px solid var(--line);
    padding:14px 16px; display:flex; align-items:center; justify-content:space-between; gap:8px; z-index:1; border-top-left-radius:18px; border-top-right-radius:18px;
  }
  .panel .body{ padding:16px; overflow:auto }
  .title{display:flex; flex-direction:column}
  .title h3{margin:0; font-size:18px}
  .subtitle{color:var(--muted); font-size:12px}

  @media (max-width: 860px){
    .row{grid-template-columns:1fr 1fr}
    .row-3{grid-template-columns:1fr 1fr}
    .row-2{grid-template-columns:1fr}
    table{min-width:760px}
  }
  @media (max-width: 560px){
    .row{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex; align-items:center; justify-content:space-between; gap:14px">
    <div>
      <h1><i class="fa-solid fa-address-book"></i> ADC · Mini CRM</h1>
      <div class="muted">Kërkon login · Të dhënat ruhen në Supabase dhe shfaqen për të gjithë të loguarit</div>
    </div>
    <div class="toolbar">
      <div id="loading" class="muted"><i class="fa-solid fa-spinner fa-spin"></i> Duke ngarkuar…</div>
      <button class="btn" onclick="refreshLeads()"><i class="fa-solid fa-rotate"></i> Rifresko</button>
      <button class="btn" onclick="downloadCSV()"><i class="fa-solid fa-file-export"></i> Eksport CSV</button>
      <span id="user_slot" class="muted"></span>
      <button class="btn" onclick="signOut()"><i class="fa-solid fa-right-from-bracket"></i> Dil</button>
    </div>
  </div>
</header>

<main class="wrap grid two" id="app">
  <!-- SHTO LEAD -->
  <section class="card">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
      <h2 style="margin:0; font-size:18px">Shto lead</h2>
      <div class="muted">Fusha <strong>NIPT</strong>, <strong>Industry</strong> dhe <strong>Activity</strong> janë opsionale.</div>
    </div>
    <div class="grid" style="margin-top:12px">
      <div class="row">
        <div>
          <label>Emri i kompanisë</label>
          <input id="f_company" placeholder="p.sh. Test sh.p.k.">
        </div>
        <div>
          <label>Person kontakti</label>
          <input id="f_contact" placeholder="Emër Mbiemër">
        </div>
        <div>
          <label>Telefon</label>
          <input id="f_phone" placeholder="+355 ...">
        </div>
        <div>
          <label>Email</label>
          <input id="f_email" type="email" placeholder="kontakt@kompania.al">
        </div>
      </div>

      <div class="row">
        <div>
          <label>NIPT (ops.)</label>
          <input id="f_nipt" placeholder="p.sh. K12345678M">
        </div>
        <div>
          <label>Industry (ops.)</label>
          <input id="f_industry" placeholder="p.sh. Energjia / Prodhim / Shërbime">
        </div>
        <div>
          <label>Activity (ops.)</label>
          <input id="f_activity" placeholder="p.sh. Furnizim me energji">
        </div>
        <div>
          <label>Burimi</label>
          <select id="f_source">
            <option>QKB</option>
            <option>Google Maps</option>
            <option>LinkedIn</option>
            <option>Tjetër</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Status Telefonate</label>
          <select id="f_call_status">
            <option>Not answered</option>
            <option>Answered</option>
            <option>Invalid number</option>
          </select>
        </div>
        <div>
          <label>Rezultati (nëse u përgjigj)</label>
          <select id="f_answer_outcome">
            <option value="">—</option>
            <option>I interesuar</option>
            <option>I pa interesuar</option>
            <option>Do ta eskaloj</option>
            <option>Do të mendohet</option>
          </select>
        </div>
        <div>
          <label>Agjent terreni (nëse caktohet takim)</label>
          <input id="f_field_agent" placeholder="p.sh. Arben H.">
        </div>
        <div>
          <label>Data takimit (ops.)</label>
          <input id="f_meeting_date" type="date">
        </div>
      </div>

      <div>
        <label>Shënime</label>
        <textarea id="f_notes" placeholder="Shënim fillestar"></textarea>
      </div>
      <div class="right">
        <button class="btn primary" onclick="addLead()"><i class="fa-solid fa-plus"></i> Shto lead</button>
      </div>
    </div>
  </section>

  <!-- LISTA -->
  <section class="card">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
      <h2 style="margin:0; font-size:18px">Leads</h2>
      <div class="toolbar">
        <input id="q" placeholder="Kërko (kompania, kontakt, tel, email)" oninput="render()">
        <select id="flt_source" onchange="render()">
          <option value="">Burimi (gjithë)</option>
          <option>QKB</option>
          <option>Google Maps</option>
          <option>LinkedIn</option>
          <option>Tjetër</option>
        </select>
        <select id="flt_call" onchange="render()">
          <option value="">Tel status (gjithë)</option>
          <option>Answered</option>
          <option>Not answered</option>
          <option>Invalid number</option>
        </select>
        <select id="flt_result" onchange="render()">
          <option value="">Rezultat (gjithë)</option>
          <option>I interesuar</option>
          <option>I pa interesuar</option>
          <option>Do ta eskaloj</option>
          <option>Do të mendohet</option>
        </select>
        <select id="flt_meeting" onchange="render()">
          <option value="">Takim (gjithë)</option>
          <option>Pending</option>
          <option>Accepted</option>
          <option>Refused - Closed</option>
        </select>
        <label class="btn"><i class="fa-solid fa-sort"></i>
          <select id="sortBy" onchange="render()" style="border:0;background:transparent">
            <option value="created_desc">Më të rejat</option>
            <option value="created_asc">Më të vjetrat</option>
            <option value="company_asc">Kompania A→Z</option>
            <option value="company_desc">Kompania Z→A</option>
            <option value="next_desc">Follow-up më urgjent</option>
          </select>
        </label>
      </div>
    </div>

    <div class="muted" id="stats" style="margin:10px 2px"></div>

    <div class="table-scroll">
      <table id="tbl">
        <thead>
          <tr>
            <th>Kompania</th>
            <th>Kontakt</th>
            <th>Burimi</th>
            <th>Tel status</th>
            <th>Rezultat</th>
            <th>Follow-up</th>
            <th>Takimi</th>
            <th>Agjenti</th>
            <th>Komente</th>
            <th class="nowrap">Veprime</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- MODAL: Faqja e biznesit / komente & aktivitet -->
<div class="modal" id="modal">
  <div class="panel">
    <div class="head">
      <div class="title">
        <h3 id="m_title"></h3>
        <div class="subtitle" id="m_meta"></div>
      </div>
      <div style="display:flex; gap:8px">
        <button class="btn" onclick="closeModal()"><i class="fa-solid fa-xmark"></i> Mbyll</button>
      </div>
    </div>

    <div class="body">
      <div class="grid" style="margin-top:4px">
        <div class="row-3">
          <div>
            <label>NIPT</label>
            <input id="m_nipt">
          </div>
          <div>
            <label>Industry</label>
            <input id="m_industry">
          </div>
          <div>
            <label>Activity</label>
            <input id="m_activity">
          </div>
        </div>

        <div class="row-2" style="margin-top:8px">
          <div>
            <label>Përditëso rezultat</label>
            <select id="m_result">
              <option value="">—</option>
              <option>I interesuar</option>
              <option>I pa interesuar</option>
              <option>Do ta eskaloj</option>
              <option>Do të mendohet</option>
            </select>
          </div>
          <div>
            <label>Follow-up (auto +3 ditë në eskalim/mendim)</label>
            <input id="m_next" type="date">
          </div>
        </div>

        <div class="row-3">
          <div>
            <label>Status takimi</label>
            <select id="m_meeting_status">
              <option value="">—</option>
              <option>Pending</option>
              <option>Accepted</option>
              <option>Refused - Closed</option>
            </select>
          </div>
          <div>
            <label>Data takimit</label>
            <input id="m_meeting_date" type="date">
          </div>
          <div>
            <label>Agjent terreni</label>
            <input id="m_agent" placeholder="p.sh. Arben H.">
          </div>
        </div>

        <div class="row-2">
          <div>
            <label>Email i klientit</label>
            <input id="m_email">
          </div>
          <div>
            <label>Telefon</label>
            <input id="m_phone">
          </div>
        </div>

        <div>
          <label>Koment i ri</label>
          <textarea id="m_comment" placeholder="Përshkrim i telefonatës / takimit / follow-up"></textarea>
        </div>

        <div class="right">
          <button class="btn" onclick="sendEmailTemplate()"><i class="fa-solid fa-envelope"></i> Dërgo email</button>
          <button class="btn" onclick="downloadICSFollowup()"><i class="fa-regular fa-calendar-plus"></i> .ics Follow-up</button>
          <button class="btn" onclick="downloadICSMeeting()"><i class="fa-regular fa-calendar"></i> .ics Takim</button>
          <button class="btn ok" onclick="saveModal()"><i class="fa-solid fa-floppy-disk"></i> Ruaj</button>
        </div>

        <div>
          <h4 style="margin:12px 0 6px 0">Kronologji (telesales & terren)</h4>
          <div id="m_timeline" class="grid"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Overlay: Supabase Auth ===== -->
<div id="auth">
  <div class="panel">
    <h3 style="margin:0 0 8px 0;font-size:18px;font-weight:800">Hyrje në Mini-CRM</h3>
    <div class="muted" style="margin-bottom:10px">Identifikohu me email dhe fjalëkalim.</div>
    <input id="auth_email" type="email" placeholder="email" style="width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:12px;margin-bottom:8px">
    <input id="auth_pwd" type="password" placeholder="fjalëkalim" style="width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:12px;margin-bottom:12px">
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn" onclick="signIn()">Hyr</button>
      <button class="btn" onclick="signUp()">Krijo</button>
    </div>
    <div id="auth_msg" style="color:#b91c1c;font-size:12px;margin-top:8px"></div>
  </div>
</div>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ===== SUPABASE CONFIG ===== */
const SUPABASE_URL = 'https://cpkyagcuowjvofgcgdwx.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwa3lhZ2N1b3dqdm9mZ2NnZHd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MjI3OTksImV4cCI6MjA3MjM5ODc5OX0.NqgKif1QO3vtigZ9eWRc8JuJLCw6JoeRIcqWwzXCIQs';

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true, storage:window.localStorage }
});

/* ===== STATE & HELPERS ===== */
let LEADS = [], COMMENTS = {}, COUNTS = new Map(), CURRENT_ID = null;
const EL = sel => document.querySelector(sel);
const ESC = s => (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m]));
function todayStr(d=new Date()){ const z=n=>String(n).padStart(2,'0'); return d.getFullYear()+'-'+z(d.getMonth()+1)+'-'+z(d.getDate()); }
function addDays(date,days){ const d=new Date(date); d.setDate(d.getDate()+days); return d; }

/* ===== AUTH ===== */
async function setUserSlotFromSession() {
  const slot = document.getElementById('user_slot');
  const { data: { user } } = await sb.auth.getUser();
  slot.textContent = user?.email ? ('• ' + user.email) : '';
}
async function requireSession(){
  const { data:{ session }, error } = await sb.auth.getSession();
  if(error) console.warn('[getSession]', error?.message || error);
  if(session && session.user){
    document.getElementById('auth').style.display='none';
    await setUserSlotFromSession();
    return true;
  } else {
    document.getElementById('auth').style.display='flex';
    return false;
  }
}
async function signIn(){
  const email = EL('#auth_email').value.trim();
  const password = EL('#auth_pwd').value;
  const msg = EL('#auth_msg');
  const { error } = await sb.auth.signInWithPassword({ email, password });
  if(error){ msg.textContent = error.message || 'Login dështoi'; return; }
  msg.textContent=''; document.getElementById('auth').style.display='none';
  await setUserSlotFromSession(); await refreshLeads();
}
async function signUp(){
  const email = EL('#auth_email').value.trim();
  const password = EL('#auth_pwd').value;
  const msg = EL('#auth_msg');
  const { error } = await sb.auth.signUp({ email, password });
  msg.textContent = error ? (error.message || 'Sign up dështoi') : 'U krijua. Nëse kërkohet, konfirmo email-in.';
}
async function signOut(){
  await sb.auth.signOut();
  LEADS=[]; COMMENTS={}; COUNTS=new Map(); render();
  document.getElementById('auth').style.display='flex';
  EL('#user_slot').textContent='';
}
sb.auth.onAuthStateChange(async (_evt, session) => {
  if(session?.user){ document.getElementById('auth').style.display='none'; await setUserSlotFromSession(); await refreshLeads(); }
  else{ document.getElementById('auth').style.display='flex'; EL('#user_slot').textContent=''; }
});

/* ===== DB READS ===== */
async function fetchCounts(){
  try{
    const { data, error } = await sb.from('lead_comment_counts').select('*');
    if(error) throw error;
    const m = new Map(); (data||[]).forEach(r=> m.set(r.lead_id, r.comments||0));
    return m;
  }catch(e){ console.warn('[counts]', e?.message||e); return new Map(); }
}
async function fetchLeads(){
  try{
    const r1 = await sb.from('leads').select('*').order('created_at_ts', {ascending:false});
    if(!r1.error) return r1.data||[];
    console.warn('[fetchLeads: created_at_ts]', r1.error?.message||r1.error);
  }catch(e){ console.warn('[fetchLeads: try1]', e?.message||e); }

  try{
    const r2 = await sb.from('leads').select('*').order('created_at', {ascending:false});
    if(!r2.error) return r2.data||[];
    console.warn('[fetchLeads: created_at]', r2.error?.message||r2.error);
  }catch(e){ console.warn('[fetchLeads: try2]', e?.message||e); }

  try{
    const r3 = await sb.from('leads').select('*');
    if(!r3.error) return r3.data||[];
    console.error('[fetchLeads: plain]', r3.error?.message||r3.error);
  }catch(e){ console.error('[fetchLeads: try3]', e?.message||e); }

  alert('Nuk u lexuan lead-et nga DB. Verifiko login-in, RLS dhe kolonat.');
  return [];
}
async function fetchComments(lead_id){
  try{
    const { data, error } = await sb.from('lead_updates').select('*').eq('lead_id', lead_id).order('ts',{ascending:false});
    if(error) throw error; return data||[];
  }catch(e){ console.warn('[fetchComments]', e?.message||e); return []; }
}

/* ===== DB WRITES ===== */
async function insertLead(obj){
  try{
    const { error } = await sb.from('leads').insert([obj]);
    if(error) throw error;
    try{ await sb.from('lead_updates').insert([{ lead_id: obj.id, kind:'create', comment:(obj._prime_note||null) }]); }catch(e){ console.warn('[log create]', e?.message||e); }
  }catch(err){
    console.error('[insertLead]', err);
    alert('Shtimi në DB dështoi. Kontrollo RLS (INSERT) dhe kolonat.');
  }
}
async function updateLeadFields(id, fields){
  try{
    const { error } = await sb.from('leads').update(fields).eq('id', id);
    if(error) throw error;
  }catch(err){ console.warn('[updateLeadFields]', err); alert('UPDATE dështoi. Vendos RLS për UPDATE te leads.'); }
}
async function insertUpdate(lead_id, payload){
  try{
    const row = Object.assign({ lead_id, kind:'update' }, payload);
    const { error } = await sb.from('lead_updates').insert([row]);
    if(error) throw error;
  }catch(err){ console.warn('[insertUpdate]', err); alert('Nuk u ruajt përditësimi (lead_updates).'); }
}
async function insertComment(lead_id, text){
  try{
    const { error } = await sb.from('lead_updates').insert([{ lead_id, kind:'comment', comment:text }]);
    if(error) throw error;
  }catch(err){ console.warn('[insertComment]', err); alert('Nuk u ruajt komenti (lead_updates).'); }
}

/* ===== BADGES ===== */
function badgeCall(s){
  if(s==='Answered') return `<span class="pill ok"><i class="fa-solid fa-phone"></i> ${s}</span>`;
  if(s==='Not answered') return `<span class="pill warn"><i class="fa-solid fa-phone-slash"></i> ${s}</span>`;
  if(s==='Invalid number') return `<span class="pill bad"><i class="fa-solid fa-triangle-exclamation"></i> ${s}</span>`;
  return `<span class="pill">${ESC(s||'—')}</span>`;
}
function badgeResult(s){
  if(!s) return `<span class="muted">—</span>`;
  if(s==='I interesuar') return `<span class="pill ok"><i class="fa-solid fa-check"></i> ${s}</span>`;
  if(s==='I pa interesuar') return `<span class="pill bad"><i class="fa-solid fa-xmark"></i> ${s}</span>`;
  if(s==='Do ta eskaloj' || s==='Do të mendohet') return `<span class="pill warn"><i class="fa-solid fa-clock"></i> ${s}</span>`;
  return `<span class="pill">${ESC(s)}</span>`;
}
function badgeMeeting(s){
  if(s==='Accepted') return `<span class="pill ok"><i class="fa-solid fa-user-check"></i> ${s}</span>`;
  if(s==='Pending') return `<span class="pill warn"><i class="fa-solid fa-hourglass-half"></i> ${s}</span>`;
  if(s==='Refused - Closed') return `<span class="pill bad"><i class="fa-solid fa-circle-xmark"></i> ${s}</span>`;
  return `<span class="pill">${ESC(s||'—')}</span>`;
}

/* ===== RENDER LIST ===== */
function render(){
  const q = (EL('#q').value||'').toLowerCase().trim();
  const fs = EL('#flt_source').value;
  const fc = EL('#flt_call').value;
  const fr = EL('#flt_result').value;
  const fm = EL('#flt_meeting').value;
  const sort = EL('#sortBy').value;

  let arr = LEADS.filter(x=>{
    const hay = ((x.company||'')+' '+(x.contact||'')+' '+(x.phone||'')+' '+(x.email||'')).toLowerCase();
    const passQ = !q || hay.includes(q);
    const passS = !fs || x.source===fs;
    const passC = !fc || x.call_status===fc;
    const passR = !fr || x.answer_outcome===fr;
    const passM = !fm || x.meeting_status===fm;
    return passQ && passS && passC && passR && passM;
  });

  if(sort==='created_desc') arr.sort((a,b)=> ((b.created_at_ts||b.created_at||'')+'').localeCompare((a.created_at_ts||a.created_at||'')+''));
  else if(sort==='created_asc') arr.sort((a,b)=> ((a.created_at_ts||a.created_at||'')+'').localeCompare((b.created_at_ts||b.created_at||'')+''));
  else if(sort==='company_asc') arr.sort((a,b)=> (a.company||'').localeCompare(b.company||'')); 
  else if(sort==='company_desc') arr.sort((a,b)=> (b.company||'').localeCompare(a.company||'')); 
  else if(sort==='next_desc') arr.sort((a,b)=> (a.next_follow_up||'9999-12-31').localeCompare(b.next_follow_up||'9999-12-31'));

  EL('#stats').textContent = `${arr.length} lead(e) · total: ${LEADS.length}`;

  EL('#rows').innerHTML = arr.map(x=>{
    const due = x.next_follow_up && x.next_follow_up <= todayStr() ? `<span class="due">Due</span>` : '';
    const commentsCount = COUNTS.get(x.id) ?? 0;
    return `<tr>
      <td>
        <a href="#" onclick="openModal('${x.id}');return false;"><strong>${ESC(x.company)}</strong></a>
        <br><span class="muted">${ESC((x.created_at||'').toString().slice(0,10))}</span>
      </td>
      <td>${ESC(x.contact||'')}<br><span class="muted">${ESC(x.phone||'')} ${x.email? ' · '+ESC(x.email):''}</span></td>
      <td><span class="chip"><i class="fa-solid fa-database"></i> ${ESC(x.source||'')}</span></td>
      <td>${badgeCall(x.call_status)}</td>
      <td>${badgeResult(x.answer_outcome)}</td>
      <td>${x.next_follow_up? ESC(x.next_follow_up): '<span class="muted">—</span>'} ${due}</td>
      <td>${badgeMeeting(x.meeting_status)}<br><span class="muted">${x.meeting_date||''}</span></td>
      <td>${ESC(x.field_agent||'')}</td>
      <td><a href="#" onclick="openModal('${x.id}');return false;"><i class="fa-regular fa-comment-dots"></i> ${commentsCount}</a></td>
      <td class="nowrap">
        <button class="btn" title="Follow-up +3 ditë" onclick="quickFollow('${x.id}')"><i class="fa-regular fa-bell"></i></button>
        <button class="btn" title="Hap" onclick="openModal('${x.id}')"><i class="fa-regular fa-pen-to-square"></i></button>
      </td>
    </tr>`;
  }).join('') || `<tr><td colspan="10" class="muted">S'ka të dhëna.</td></tr>`;
}

/* ===== ADD LEAD ===== */
function clearForm(){
  ['f_company','f_contact','f_phone','f_email','f_nipt','f_industry','f_activity','f_field_agent','f_meeting_date','f_notes'].forEach(id=> EL('#'+id).value='');
  EL('#f_source').value='QKB'; EL('#f_call_status').value='Not answered'; EL('#f_answer_outcome').value='';
}
async function addLead(){
  const obj = {
    id: 'L'+Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(-4),
    created_at: todayStr(),
    company: EL('#f_company').value.trim(),
    contact: EL('#f_contact').value.trim(),
    phone: EL('#f_phone').value.trim(),
    email: EL('#f_email').value.trim(),
    nipt: EL('#f_nipt').value.trim() || null,
    industry: EL('#f_industry').value.trim() || null,
    activity: EL('#f_activity').value.trim() || null,
    source: EL('#f_source').value,
    call_status: EL('#f_call_status').value,
    answer_outcome: EL('#f_answer_outcome').value || null,
    next_follow_up: null,
    meeting_status: null,
    meeting_date: EL('#f_meeting_date').value || null,
    field_agent: EL('#f_field_agent').value.trim() || null,
    _prime_note: EL('#f_notes').value.trim() || null
  };
  if(!obj.company || !obj.phone){ alert('Kompania dhe telefoni janë të detyrueshëm.'); return; }
  if(obj.answer_outcome==='Do ta eskaloj' || obj.answer_outcome==='Do të mendohet'){
    obj.next_follow_up = todayStr(addDays(new Date(),3));
  }
  if(obj.meeting_date) obj.meeting_status = 'Pending';

  EL('#loading').style.display='inline-flex';
  try{ await insertLead(obj); await refreshLeads(); clearForm(); }
  catch(err){ console.error('[addLead outer]', err); alert('Shtimi dështoi.'); }
  finally{ EL('#loading').style.display='none'; }
}

/* ===== MODAL ===== */
async function openModal(id){
  CURRENT_ID = id;
  const x = LEADS.find(i=>i.id===id); if(!x) return;
  EL('#m_title').textContent = x.company;
  EL('#m_meta').innerHTML = `${ESC(x.contact||'')} · <span class="muted">${ESC(x.phone||'')}</span> · <span class="muted">${ESC(x.email||'')}</span>`;
  EL('#m_nipt').value = x.nipt || ''; EL('#m_industry').value = x.industry || ''; EL('#m_activity').value = x.activity || '';
  EL('#m_result').value = x.answer_outcome || ''; EL('#m_next').value = x.next_follow_up || '';
  EL('#m_meeting_status').value = x.meeting_status || ''; EL('#m_meeting_date').value = x.meeting_date || '';
  EL('#m_agent').value = x.field_agent || ''; EL('#m_email').value = x.email || ''; EL('#m_phone').value = x.phone || ''; EL('#m_comment').value = '';

  COMMENTS[id] = await fetchComments(id);
  renderTimeline(id);

  document.getElementById('modal').style.display='flex';
}
function renderTimeline(id){
  const arr = COMMENTS[id] || [];
  const html = arr.map(c=>{
    const d = new Date(c.ts);
    const meta = c.kind==='comment' ? 'Koment' : (c.kind==='create' ? 'Krijuar' : 'Përditësim');
    const details = [
      c.comment ? `<div>${ESC(c.comment)}</div>` : '',
      c.new_result ? `<div><strong>Rezultat:</strong> ${ESC(c.new_result)}</div>` : '',
      c.next_follow_up ? `<div><strong>Follow-up:</strong> ${ESC(c.next_follow_up)}</div>` : '',
      c.meeting_status ? `<div><strong>Takimi:</strong> ${ESC(c.meeting_status)} ${c.meeting_date? ' · '+ESC(c.meeting_date):''}</div>` : '',
      c.field_agent ? `<div><strong>Agjent:</strong> ${ESC(c.field_agent)}</div>` : '',
      c.email ? `<div><strong>Email:</strong> ${ESC(c.email)}</div>` : ''
    ].filter(Boolean).join('');
    return `<div class="card" style="padding:12px">
      <div class="muted">${meta} · ${d.toLocaleString()}</div>
      <div style="margin-top:6px">${details || '<em class="muted">—</em>'}</div>
    </div>`;
  }).join('');
  document.getElementById('m_timeline').innerHTML = html || `<div class="muted">S’ka komente ende.</div>`;
}
function closeModal(){ document.getElementById('modal').style.display='none'; CURRENT_ID=null; }

/* ===== SAVE & QUICK FOLLOW ===== */
async function saveModal(){
  const x = LEADS.find(i=>i.id===CURRENT_ID); if(!x) return;
  const newResult = EL('#m_result').value || null;
  const nextFU = EL('#m_next').value || null;
  const mStatus = EL('#m_meeting_status').value || null;
  const mDate = EL('#m_meeting_date').value || null;
  const agent = (EL('#m_agent').value||'').trim() || null;
  const email = (EL('#m_email').value||'').trim() || null;
  const phone = (EL('#m_phone').value||'').trim() || null;
  const nipt = (EL('#m_nipt').value||'').trim() || null;
  const industry = (EL('#m_industry').value||'').trim() || null;
  const activity = (EL('#m_activity').value||'').trim() || null;
  const comment = (EL('#m_comment').value||'').trim();

  const autoFU = (!nextFU && (newResult==='Do ta eskaloj' || newResult==='Do të mendohet')) ? todayStr(addDays(new Date(),3)) : null;

  EL('#loading').style.display='inline-flex';
  try{
    await insertUpdate(x.id, {
      new_result: newResult,
      next_follow_up: nextFU || autoFU,
      meeting_status: mStatus,
      meeting_date: mDate,
      field_agent: agent,
      email: email,
      comment: comment || null
    });
    if(comment){ await insertComment(x.id, comment); }

    await updateLeadFields(x.id, {
      answer_outcome: newResult,
      next_follow_up: nextFU || autoFU,
      meeting_status: mStatus,
      meeting_date: mDate,
      field_agent: agent,
      email: email,
      phone: phone,
      nipt: nipt,
      industry: industry,
      activity: activity
    });

    await refreshLeads();
    COMMENTS[x.id] = await fetchComments(x.id);
    renderTimeline(x.id);
  }catch(err){ console.error('[saveModal]', err); alert('Ruajtja dështoi.'); }
  finally{ EL('#loading').style.display='none'; }
}
async function quickFollow(id){
  const x = LEADS.find(i=>i.id===id); if(!x) return;
  const next = todayStr(addDays(new Date(),3));
  EL('#loading').style.display='inline-flex';
  try{
    await insertUpdate(id, { new_result: x.answer_outcome || null, next_follow_up: next });
    await updateLeadFields(id, { next_follow_up: next });
    await refreshLeads();
  }catch(err){ console.error('[quickFollow]', err); alert('S’përditësua follow-up.'); }
  finally{ EL('#loading').style.display='none'; }
}

/* ===== EMAIL & ICS ===== */
function sendEmailTemplate(){
  const x = LEADS.find(i=>i.id===CURRENT_ID); if(!x) return;
  const to = x.email || '';
  const subj = encodeURIComponent(`Lidhur me bashkëpunimin · ${x.company}`);
  const body = encodeURIComponent(
`Përshëndetje ${x.contact||'—'},

Ju falënderojmë për kohën në telefon. Siç u dakorduam, po ju përcjellim informacionin për shërbimet tona. 
Do të rikthehemi me një telefonatë follow-up brenda 3 ditësh (ose sipas mundësive tuaja).

— Detaje:
• Kompania: ${x.company}
• Kontakt: ${x.contact||''}
• Tel: ${x.phone||''}

Faleminderit,
ADC`
  );
  window.location.href = `mailto:${to}?subject=${subj}&body=${body}`;
}
function makeICS({title, description, date, durationMinutes=30}){
  const dt = new Date(date+'T09:00:00');
  const dtEnd = new Date(dt.getTime() + durationMinutes*60000);
  const fmt = d => d.toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z$/,'Z');
  const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//ADC Mini CRM//EN
CALSCALE:GREGORIAN
BEGIN:VEVENT
DTSTAMP:${fmt(new Date())}
DTSTART:${fmt(dt)}
DTEND:${fmt(dtEnd)}
SUMMARY:${title}
DESCRIPTION:${description.replace(/\r?\n/g,'\\n')}
END:VEVENT
END:VCALENDAR`;
  const blob = new Blob([ics], {type:'text/calendar;charset=utf-8;'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`${title.replace(/\s+/g,'_')}.ics`; a.click();
}
function downloadICSFollowup(){
  const x = LEADS.find(i=>i.id===CURRENT_ID); if(!x) return;
  if(!x.next_follow_up){ alert('Së pari vendos datën e follow-up.'); return; }
  makeICS({ title:`Follow-up · ${x.company}`, description:`Telefonatë follow-up për ${x.company}\nKontakt: ${x.contact||''}\nTel: ${x.phone||''}`, date:x.next_follow_up });
}
function downloadICSMeeting(){
  const x = LEADS.find(i=>i.id===CURRENT_ID); if(!x) return;
  if(!x.meeting_date){ alert('Së pari vendos datën e takimit.'); return; }
  makeICS({ title:`Takim · ${x.company}`, description:`Takim me ${x.company}\nKontakt: ${x.contact||''}\nTel: ${x.phone||''}\nAgjent: ${x.field_agent||''}`, date:x.meeting_date });
}

/* ===== CSV ===== */
function downloadCSV(){
  const cols = ["id","created_at","company","nipt","industry","activity","contact","phone","email","source","call_status","answer_outcome","next_follow_up","meeting_status","meeting_date","field_agent"];
  const lines = [cols.join(',')];
  LEADS.forEach(x=>{
    const row = [x.id,x.created_at,x.company,x.nipt||'',x.industry||'',x.activity||'',x.contact||'',x.phone||'',x.email||'',x.source||'',x.call_status||'',x.answer_outcome||'',x.next_follow_up||'',x.meeting_status||'',x.meeting_date||'',x.field_agent||'']
      .map(v => `"${String(v??'').replace(/"/g,'""')}"`);
    lines.push(row.join(','));
  });
  const blob = new Blob([lines.join('\r\n')], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='adc_leads.csv'; a.click();
}

/* ===== FLOW ===== */
async function refreshLeads(){
  const L = EL('#loading'); if(L) L.style.display='inline-flex';
  try{
    const [leads, counts] = await Promise.all([ fetchLeads(), fetchCounts() ]);
    LEADS = Array.isArray(leads)? leads: [];
    COUNTS = counts instanceof Map ? counts : new Map();
    render();
  }catch(err){ console.error('[refreshLeads]', err); alert('Gabim gjatë rifreskimit të të dhënave.'); }
  finally{ if(L) L.style.display='none'; }
}

/* ===== INIT ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  const ok = await requireSession();
  if(ok){ await refreshLeads(); }
});
</script>
</body>
</html>

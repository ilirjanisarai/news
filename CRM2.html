<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ADC · Mini CRM</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
  :root{
    --brand:#2563eb; --brand-2:#1d4ed8; --ok:#16a34a; --warn:#d97706; --bad:#b91c1c;
    --text:#0b1220; --muted:#6b7280; --line:#e5e7eb; --surface:#fff; --surface-2:#f9fafb;
    --shadow:0 4px 16px rgba(0,0,0,.08); --radius:14px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial; color:var(--text); background:#f3f4f6}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line);box-shadow:var(--shadow)}
  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  h1{font-size:20px;font-weight:800}
  .toolbar{display:flex;gap:10px;align-items:center}
  .btn{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:10px;padding:8px 12px;cursor:pointer;background:#fff;font-weight:600;transition:.2s}
  .btn:hover{background:#f1f5f9}
  .btn.primary{background:linear-gradient(180deg,var(--brand),var(--brand-2));color:#fff;border:none}
  .btn.primary:hover{opacity:.9}
  .card{background:var(--surface);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  label{font-weight:600;font-size:13px;color:var(--muted)}
  input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:var(--surface-2);font-size:14px}
  textarea{min-height:80px}
  .grid{display:grid;gap:14px}
  .row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .row-2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .row-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
  th{color:var(--muted);font-size:12px}
  tr:hover td{background:#f9fafb}
  .muted{color:var(--muted);font-size:12px}
  .pill{padding:2px 8px;border-radius:999px;font-size:12px;font-weight:600}
  .pill.ok{background:#dcfce7;color:#166534}
  .pill.warn{background:#fef3c7;color:#92400e}
  .pill.bad{background:#fee2e2;color:#7f1d1d}
  #loading{display:none;align-items:center;gap:6px;font-weight:600;color:var(--muted)}
  #auth{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.1);backdrop-filter:blur(4px);z-index:9999}
  #auth .panel{background:#fff;border-radius:14px;box-shadow:var(--shadow);padding:20px;width:340px;max-width:95%}
  #auth input{margin-bottom:10px}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000}
  .modal .panel{background:#fff;border-radius:16px;max-width:900px;width:95%;max-height:90vh;overflow:auto;padding:20px}
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex;align-items:center;justify-content:space-between">
    <h1><i class="fa-solid fa-address-book"></i> ADC · Mini CRM</h1>
    <div class="toolbar">
      <div id="loading"><i class="fa-solid fa-spinner fa-spin"></i> Duke ngarkuar…</div>
      <button class="btn" onclick="refreshLeads()"><i class="fa-solid fa-rotate"></i> Rifresko</button>
      <button class="btn" onclick="downloadCSV()"><i class="fa-solid fa-file-export"></i> Eksport</button>
      <span id="user_slot" class="muted"></span>
      <button class="btn" onclick="signOut()"><i class="fa-solid fa-right-from-bracket"></i> Dil</button>
    </div>
  </div>
</header>

<main class="wrap grid">
  <!-- Forma e shtimit -->
  <section class="card">
    <h2 style="margin-bottom:10px;font-size:16px">Shto lead</h2>
    <div class="row">
      <div><label>Kompania</label><input id="f_company"></div>
      <div><label>Kontakt</label><input id="f_contact"></div>
      <div><label>Tel</label><input id="f_phone"></div>
      <div><label>Email</label><input id="f_email"></div>
    </div>
    <div class="row">
      <div><label>NIPT</label><input id="f_nipt"></div>
      <div><label>Industry</label><input id="f_industry"></div>
      <div><label>Activity</label><input id="f_activity"></div>
      <div><label>Burimi</label>
        <select id="f_source"><option>QKB</option><option>Google Maps</option><option>LinkedIn</option><option>Tjetër</option></select>
      </div>
    </div>
    <div class="row-2">
      <div><label>Status Tel</label>
        <select id="f_call_status"><option>Not answered</option><option>Answered</option><option>Invalid number</option></select>
      </div>
      <div><label>Rezultat</label>
        <select id="f_answer_outcome"><option value="">—</option><option>I interesuar</option><option>I pa interesuar</option><option>Do ta eskaloj</option><option>Do të mendohet</option></select>
      </div>
    </div>
    <div><label>Shënime</label><textarea id="f_notes"></textarea></div>
    <div style="text-align:right"><button class="btn primary" onclick="addLead()">+ Shto lead</button></div>
  </section>

  <!-- Lista -->
  <section class="card">
    <h2 style="margin-bottom:10px;font-size:16px">Leads</h2>
    <div class="muted" id="stats"></div>
    <div style="overflow:auto">
      <table><thead><tr>
        <th>Kompania</th><th>Kontakt</th><th>Burimi</th><th>Tel status</th><th>Rezultat</th><th>Veprime</th>
      </tr></thead><tbody id="rows"></tbody></table>
    </div>
  </section>
</main>

<!-- Modal për detajet -->
<div class="modal" id="modal">
  <div class="panel">
    <h3 id="m_title"></h3>
    <div id="m_meta" class="muted" style="margin-bottom:10px"></div>
    <textarea id="m_comment" placeholder="Shto koment..." style="width:100%"></textarea>
    <div style="text-align:right;margin-top:10px"><button class="btn primary" onclick="closeModal()">Mbyll</button></div>
  </div>
</div>

<!-- Login overlay -->
<div id="auth">
  <div class="panel">
    <h3 style="margin-bottom:8px">Hyrje</h3>
    <input id="auth_email" type="email" placeholder="Email">
    <input id="auth_pwd" type="password" placeholder="Fjalëkalim">
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn primary" onclick="signIn()">Hyr</button>
      <button class="btn" onclick="signUp()">Krijo</button>
    </div>
    <div id="auth_msg" class="muted" style="margin-top:8px;color:#b91c1c"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* Konfigurim Supabase */
const sb = supabase.createClient(
 'https://cpkyagcuowjvofgcgdwx.supabase.co',
 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwa3lhZ2N1b3dqdm9mZ2NnZHd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MjI3OTksImV4cCI6MjA3MjM5ODc5OX0.NqgKif1QO3vtigZ9eWRc8JuJLCw6JoeRIcqWwzXCIQs',
 { auth:{persistSession:true,autoRefreshToken:true,detectSessionInUrl:false} }
);

let LEADS=[]; const EL=s=>document.querySelector(s);

async function ensureAuth(){
  const { data:{session} }=await sb.auth.getSession();
  if(session?.user){ EL('#auth').style.display='none'; EL('#user_slot').textContent='• '+session.user.email; return true;}
  EL('#auth').style.display='flex'; EL('#user_slot').textContent=''; return false;
}
async function signIn(){
  const email=EL('#auth_email').value.trim(); const pwd=EL('#auth_pwd').value;
  const {error}=await sb.auth.signInWithPassword({email,password:pwd});
  EL('#auth_msg').textContent=error?error.message:''; if(!error){await ensureAuth();await refreshLeads();}
}
async function signUp(){
  const email=EL('#auth_email').value.trim(); const pwd=EL('#auth_pwd').value;
  const {error}=await sb.auth.signUp({email,password:pwd}); EL('#auth_msg').textContent=error?error.message:'User u krijua.';
}
async function signOut(){ await sb.auth.signOut(); await ensureAuth(); }
sb.auth.onAuthStateChange(async(_,session)=>{ if(session){await ensureAuth();await refreshLeads();}else{await ensureAuth();} });

async function fetchLeads(){
  const {data,error}=await sb.from('leads').select('*').order('created_at',{ascending:false});
  if(error){console.error(error);return [];} return data||[];
}
async function addLead(){
  const obj={id:'L'+Date.now(),created_at:new Date().toISOString(),company:EL('#f_company').value,contact:EL('#f_contact').value,phone:EL('#f_phone').value,email:EL('#f_email').value,nipt:EL('#f_nipt').value,industry:EL('#f_industry').value,activity:EL('#f_activity').value,source:EL('#f_source').value,call_status:EL('#f_call_status').value,answer_outcome:EL('#f_answer_outcome').value,notes:EL('#f_notes').value};
  const {error}=await sb.from('leads').insert([obj]); if(error)alert(error.message); await refreshLeads();
}
function render(){
  EL('#rows').innerHTML=LEADS.map(x=>`<tr>
    <td><a href="#" onclick="openModal('${x.id}');return false;">${x.company}</a></td>
    <td>${x.contact||''}</td>
    <td>${x.source||''}</td>
    <td><span class="pill ${x.call_status==='Answered'?'ok':x.call_status==='Not answered'?'warn':'bad'}">${x.call_status}</span></td>
    <td>${x.answer_outcome||''}</td>
    <td><button class="btn" onclick="openModal('${x.id}')">Hap</button></td>
  </tr>`).join('');
  EL('#stats').textContent=`${LEADS.length} lead(e)`;
}
async function refreshLeads(){EL('#loading').style.display='inline-flex';LEADS=await fetchLeads();render();EL('#loading').style.display='none';}
function openModal(id){const x=LEADS.find(l=>l.id===id);if(!x)return;EL('#m_title').textContent=x.company;EL('#m_meta').textContent=x.contact+' · '+(x.phone||'');EL('#modal').style.display='flex';}
function closeModal(){EL('#modal').style.display='none';}
function downloadCSV(){const cols=["id","created_at","company","contact","phone","email","nipt","industry","activity","source","call_status","answer_outcome"];const lines=[cols.join(',')];LEADS.forEach(x=>{const row=cols.map(c=>`"${(x[c]||'').toString().replace(/"/g,'""')}"`);lines.push(row.join(','));});const blob=new Blob([lines.join('\n')],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='leads.csv';a.click();}
document.addEventListener('DOMContentLoaded',async()=>{if(await ensureAuth())await refreshLeads();});
</script>
</body>
</html>
